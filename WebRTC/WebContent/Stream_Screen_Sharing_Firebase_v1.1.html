<html>
<head>

<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>

<link
	href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css"
	rel="stylesheet">

<style type="text/css">
video {
	background-color: #ddd;
	border-radius: 7px;
	margin: 10px 0px 0px 10px;
	width: 320px;
	height: 240px;
}

button {
	margin: 5px 0px 0px 10px !important;
	width: 654px;
}
</style>


</head>


<body >
	
	<div id="message" class="info">Can play type "video/mp4": maybe</div>
	<input type="file" accept="video/*">

	Broadcast:
	<video id="yourVideo" autoplay  controls>
		Your browser does not support the video tag.
	</video>

	<br/>
	
	<p><button id="start">Start Capture</button> 
	
	</p>
	
	<button id="stop">Stop Capture</button>
	
	</p>

	Guest:
	<video id="friendsVideo" autoplay controls></video>


	<br />
	
	<strong>Log:</strong>
		<br>
		<pre id="log"></pre>
		
	<br/>

	<button onclick="showFriendsFace()" type="button"
		class="btn btn-primary btn-lg">
		<span class="glyphicon glyphicon-facetime-video" aria-hidden="true"></span>
		Call
	</button>


<script type="text/javascript">

(function localFileVideoPlayer() {
	'use strict'
  var URL = window.URL || window.webkitURL
  var displayMessage = function (message, isError) {
    var element = document.querySelector('#message')
    element.innerHTML = message
    element.className = isError ? 'error' : 'info'
  }
  var playSelectedFile = function (event) {
    var file = this.files[0]
    var type = file.type
    //var videoNode = document.querySelector('video')
    var videoNode = document.getElementById("yourVideo");
    var canPlay = videoNode.canPlayType(type)
    if (canPlay === '') canPlay = 'no'
    var message = 'Can play type "' + type + '": ' + canPlay
    var isError = canPlay === 'no'
    displayMessage(message, isError)

    if (isError) {
      return
    }

    var fileURL = URL.createObjectURL(file)
    videoNode.src = fileURL
  }
  var inputNode = document.querySelector('input')
  inputNode.addEventListener('change', playSelectedFile, false)
})()


</script>


<script type="text/javascript">

var firebaseConfig = {
	    apiKey: "AIzaSyC40QEOwiFQF3BpT24l3FBa_H8cygSHFZU",
	    authDomain: "webrtcdemo-2cca4.firebaseapp.com",
	    databaseURL: "https://webrtcdemo-2cca4.firebaseio.com",
	    projectId: "webrtcdemo-2cca4",
	    storageBucket: "webrtcdemo-2cca4.appspot.com",
	    messagingSenderId: "90868998821",
	    appId: "1:90868998821:web:78d8665d6082aad092e34c",
	    measurementId: "G-PR82EL0XGZ"
	  };

firebase.initializeApp(firebaseConfig);
var database = firebase.database().ref();
var yourVideo = document.getElementById("yourVideo");
var friendsVideo = document.getElementById("friendsVideo");
//var yourId = Math.floor(Math.random()*1000000000);

var yourId = "Main-node";

var servers = {'iceServers': [{'urls': 'stun:stun.services.mozilla.com'}, {'urls': 'stun:stun.l.google.com:19302'}, {'urls': 'turn:numb.viagenie.ca','credential': 'webrtc','username': 'websitebeaver@mail.com'}]};

// Peer connection 1
var pc1 = new RTCPeerConnection(servers);
pc1.onicecandidate = (event => event.candidate?sendMessage(yourId, JSON.stringify({'ice': event.candidate})):console.log("Sent All Ice") );
pc1.onaddstream = (event => friendsVideo.srcObject = event.stream);

//Peer connection 2
var pc2 = new RTCPeerConnection(servers);
pc2.onicecandidate = (event => event.candidate?sendMessage(yourId, JSON.stringify({'ice': event.candidate})):console.log("Sent All Ice") );
pc2.onaddstream = (event => friendsVideo.srcObject = event.stream);

yourVideo.onplay = function() {
	const stream = yourVideo.captureStream();
	pc1.addStream(stream);
	pc2.addStream(stream);	
};
//pc.addStream(yourVideo.captureStream());

function sendMessage(senderId, data) {
	var msg = database.push({ sender: senderId, message: data });
	msg.remove();
};

function readMessage(data) {
	var msg = JSON.parse(data.val().message);
	var sender = data.val().sender;
	/*
	if (sender != yourId) {
		if (msg.ice != undefined)
		{
			pc.addIceCandidate(new RTCIceCandidate(msg.ice));
		}
		else if (msg.sdp.type == "offer")
		{
			var r = confirm("Answer call?");
			if (r == true) {
				pc.setRemoteDescription(new RTCSessionDescription(msg.sdp))
				.then(() => pc.createAnswer())
				.then(answer => pc.setLocalDescription(answer))
				.then(() => sendMessage(yourId, JSON.stringify({'sdp': pc.localDescription})));
			} else {
				alert("Rejected the call");
			}
		}
		else if (msg.sdp.type == "answer")
		{
			pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
		}
	}
	*/
	if (msg.ice != undefined) {
		if (sender == "Subs-node1") {
			pc1.addIceCandidate(new RTCIceCandidate(msg.ice));
		} else if (sender == "Subs-node2") {
			pc2.addIceCandidate(new RTCIceCandidate(msg.ice));
		}
	} else if (msg.sdp.type == "answer") {
		if (sender == "Subs-node1") {
			pc1.setRemoteDescription(new RTCSessionDescription(msg.sdp));
		} else if (sender == "Subs-node2") {
			pc2.setRemoteDescription(new RTCSessionDescription(msg.sdp));
		}
	}
};

database.on('child_added', readMessage);

function showMyFace() {
	navigator.mediaDevices.getUserMedia({audio:true, video:true})
	.then(stream => yourVideo.srcObject = stream)
	.then(stream => pc.addStream(stream));
}
function showFriendsFace() {
	pc1.createOffer()
	.then(offer => pc1.setLocalDescription(offer) )
	.then(() => sendMessage("Subs-node1", JSON.stringify({'sdp': pc1.localDescription})) );
	
	pc2.createOffer()
	.then(offer => pc2.setLocalDescription(offer) )
	.then(() => sendMessage("Subs-node2", JSON.stringify({'sdp': pc2.localDescription})) );
}

</script>


        
		<script>
			const videoElem = yourVideo;
			const logElem = document.getElementById("log");
			const startElem = document.getElementById("start");
			const stopElem = document.getElementById("stop");
			
			// Options for getDisplayMedia()
			
			var displayMediaOptions = {
			  video: {
			    cursor: "always"
			  },
			  audio: false
			};
			
			// Set event listeners for the start and stop buttons
			startElem.addEventListener("click", function(evt) {
			  startCapture();
			}, false);
			
			stopElem.addEventListener("click", function(evt) {
			  stopCapture();
			}, false); 
			
			console.log = msg => logElem.innerHTML += `${msg}<br>`;
			console.error = msg => logElem.innerHTML += `<span class="error">${msg}</span><br>`;
			console.warn = msg => logElem.innerHTML += `<span class="warn">${msg}<span><br>`;
			console.info = msg => logElem.innerHTML += `<span class="info">${msg}</span><br>`; 
			
			async function startCapture() {
			  logElem.innerHTML = "";			
			  try {
			    videoElem.srcObject = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
			    dumpOptionsInfo();
			  } catch(err) {
			    console.error("Error: " + err);
			  }
			} 
			
			
			function stopCapture(evt) {
			  let tracks = videoElem.srcObject.getTracks();
			
			  tracks.forEach(track => track.stop());
			  videoElem.srcObject = null;
			} 
			
			function dumpOptionsInfo() {
			  const videoTrack = videoElem.srcObject.getVideoTracks()[0];
			 
			  console.info("Track settings:");
			  console.info(JSON.stringify(videoTrack.getSettings(), null, 2));
			  console.info("Track constraints:");
			  console.info(JSON.stringify(videoTrack.getConstraints(), null, 2));
			}
        </script>
        
</body>
</html>